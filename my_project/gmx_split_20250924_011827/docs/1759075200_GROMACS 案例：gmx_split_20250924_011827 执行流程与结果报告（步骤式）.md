# GROMACS 案例：gmx_split_20250924_011827 执行流程与结果报告（步骤式）

- 作者：GaoZheng
- 日期：2025-09-29

本文档将案例流程拆分为可复现的步骤，并补充涉及脚本的使用方式，便于一键复用或在其他项目参考。

## 概览

- 目录：`out/gmx_split_20250924_011827`
- 复合物：`complex.gro`（1890 原子）
- 力场/拓扑：蛋白 `amber99sb-ildn`，水 `tip3p`，配体 GAFF2（ACPYPE 生成）
- 评分思路：`gmx mdrun -rerun` + `gmx energy`，取 `Coul-SR:Protein-Ligand + LJ-SR:Protein-Ligand` 之和

## 步骤 0：环境准备

- 需要可用的 GROMACS（`gmx` 在 PATH）
- 若需生成/转换小分子：建议安装 AmberTools（`antechamber`）与 Open Babel（`obabel`）
- 可选 conda 示例：
  - `conda create -n amber -c conda-forge ambertools openbabel -y && conda activate amber`

## 步骤 1：生成配体 mol2（脚本）

- 脚本：`my_scripts/generate_hiv_mol2_wsl.sh`
- 用法：
  - 从 SMILES 生成：
    - `bash my_scripts/generate_hiv_mol2_wsl.sh --smiles "c1ccccc1C(=O)N" --charge 0 --resname LIG --out hiv.mol2`
  - 从现有结构生成：
    - `bash my_scripts/generate_hiv_mol2_wsl.sh --input lig.pdb --charge 0 --resname LIG --out hiv.mol2`
- 日志会写入 `logs/generate_hiv_mol2_wsl.*.log`
- 说明：脚本内部调用 `obabel` 生成 3D SDF，再用 `antechamber` 输出 Tripos mol2（GAFF2 + BCC 电荷）

## 步骤 2：配体参数化（ACPYPE）

- 示例命令：`acpype -i hiv.mol2 -b LIG -o gmx`
- 产物目录：`LIG.acpype/`
  - `LIG_GMX.itp`、`LIG_GMX.gro`、`posre_LIG.itp` 等
  - `acpype.log`：统计（示例：原子 16、键 16、角 24、proper 二面角 34（RB 32）、improper 8），净电荷 0

## 步骤 3：组装拓扑与体系

- `topol.top` 已包含：
  - `#include "amber99sb-ildn.ff/forcefield.itp"`
  - `#include "LIG.acpype/LIG_GMX.itp"`
  - `#include "amber99sb-ildn.ff/tip3p.itp"`
- `complex.gro` 为复合物坐标；`index.ndx` 包含 `[ Protein ]`（1872 原子）与 `[ Ligand ]`（18 原子）
- 若需新建索引：`gmx make_ndx -f complex.gro -o index.ndx`，确保存在 `[ Protein ]` 与 `[ Ligand ]`

## 步骤 4：生成 tpr（grompp）

- 参数文件：`em.mdp`（`nsteps=0`，用于生成 `tpr` 供 rerun，非真正最小化）
- 命令：`gmx grompp -f em.mdp -c complex.gro -p topol.top -o em.tpr`
- 参考展开：`mdout.mdp`（记录了 grompp 展开的全部参数）

## 步骤 5：rerun 评分（单构型）

- 示例：以 `complex.gro` 自身评分
  - `gmx mdrun -s em.tpr -rerun complex.gro -deffnm score --nt 1 -nb cpu`
- 提取能量（选择项依次选择 `Coul-SR:Protein-Ligand` 与 `LJ-SR:Protein-Ligand`，最后输入 0）：
  - `gmx energy -f score.edr -xvg none -o score_terms.xvg`
- 判读：取 `score_terms.xvg` 最后一行两列相加；越小越优（仅作相对筛选参考）

## 步骤 6：批量候选生成与评分（脚本）

- 脚本：`my_scripts/dock_minimal.py`
- 功能：在 `complex.gro` 上对配体做随机刚体扰动（平移/旋转），对每个候选用 `-rerun` 评分，输出 `scores.csv`
- 用法示例：
```
python my_scripts/dock_minimal.py \
  --gmx gmx \
  --tpr em.tpr \
  --structure complex.gro \
  --ndx index.ndx \
  --workdir out_scoring \
  --n-poses 50 --trans 0.5 --rot 20 --jobs 2 --nt 1 --seed 42
```
- 输出：`out_scoring/scores.csv`（按得分升序），并在控制台打印 Top-10
- 约束：`index.ndx` 中需存在组名 `Ligand`；`em.mdp` 中 `energygrps` 已设为 `Protein Ligand`

## 注意与建议

- 力场标注与 include 统一：`topol.top` 头注写 AMBER14SB，但 include 为 `amber99sb-ildn`；请根据实际统一。
- 确认 `[ Ligand ]` 真为小分子配体（当前 18 原子，来自 `resname_CSO`），避免将蛋白修饰残基计入配体能量。
- `em.mdp` 为快速评分的 Cut-off 设置；若需更严谨能量，建议 PME 与生产参数一致。

## 脚本与命令速查

- 生成配体 mol2：`my_scripts/generate_hiv_mol2_wsl.sh`（WSL 友好，产生日志在 `logs/`）
- 批量候选评分：`my_scripts/dock_minimal.py`（需要 `gmx` 可用，`index.ndx` 含 `Ligand`）
- 单配体盒内测试样例（ACPYPE 输出中的示例脚本，仅供参考）：`LIG.acpype/rungmx.sh`

## 当前目录状态与结论

- 已有：`complex.gro`、`topol.top`、`em.mdp`、`index.ndx`、`LIG.acpype/`、日志 `logs/`
- 已执行：`grompp`（见 `mdout.mdp` 头部记录）
- 未发现：`em.tpr/.edr/.xvg`，推断尚未执行步骤 5 的 rerun 与能量提取

---
如需把上述步骤封装为一键脚本（在本目录自动执行 4–6 步并产出 `score_terms.xvg`/`scores.csv`），可告知我继续补充。 

---

**许可声明 (License)**

Copyright (C) 2025 GaoZheng

本文档采用[知识共享-署名-非商业性使用-禁止演绎 4.0 国际许可协议 (CC BY-NC-ND 4.0)](https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh-Hans)进行许可。
